app-id: com.zandronum.Zandronum
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: "5.15"
command: doomseeker

finish-args:
- --device=dri
- --socket=wayland
- --socket=x11
- --share=ipc
- --share=network
- --socket=pulseaudio

# Based on GZDoom
# Now for something confusing: Doomseeker honours XDG standards
# But Zandronum doesn't. Both persist for consistency.
- --env=DOOMWADDIR=/app/share/games/doom
- --persist=.config/zandronum
- --persist=.config/doomseeker

cleanup:
- /app/include
- /app/lib/*.a
- /app/lib/*.la
- /app/lib/pkgconfig

modules:

- shared-modules/glu/glu-9.json
- shared-modules/glew/glew.json
- shared-modules/gtk2/gtk2.json

# Warning, must be in this order... SDL last
- shared-modules/SDL/SDL-1.2.15.json

# Building it from source is not really feasable at the moment. To many statically linked
# libraries, which are all bundles, are causing trouble. In the future, when
# newer versions of Zandronum update their dependencies, we should buid from source again.
- name: zandronum
  buildsystem: simple
  build-commands:
  - tar xjf zandronum3.0-linux-x86_64.tar.bz2
  - install -D ./zandronum /app/bin/zandronum
  - install -D ./zandronum-server /app/bin/zandronum-server
  - install -D ./skulltag_actors.pk3 /app/share/games/skulltag_actors.pk3
  - install -D ./zandronum.pk3 /app/share/games/doom/zandronum.pk3
  - install -D ./liboutput_sdl.so /app/lib/liboutput_sdl.so
  - install -D ./libcrypto.so.1.0.0 /app/lib/libcrypto.so.1.0.0
  - install -D ./libfmodex64-4.24.16.so /app/lib/libfmodex64-4.24.16.so
  sources:
  - type: file
    url: https://zandronum.com/downloads/zandronum3.0-linux-x86_64.tar.bz2
    sha256: fdc9b2767190a16aed0cec5e48204f9b285ca19e51e84f74889863560d2287b6

- name: doomseeker
  buildsystem: cmake-ninja
  config-opts:
  - -DCMAKE_SKIP_RPATH=true
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - -DCMAKE_INSTALL_PREFIX=/app
  sources:
  - type: archive
    url: https://bitbucket.org/Doomseeker/doomseeker/get/1.3.1.tar.bz2
    sha256: b55a96559dbd32c343e65634ac2b9de6e0128928e1eaeac3bb3dd19c88b8f2df
  - type: shell
    commands:
    # Current upstream system makes use of Mercurial. There are plans
    # to migrate to Git, but at the time of writing, this works best.
    - sed -i 's/HG_REVISION_HASH_STRING/"Flatpak Edition"/g' ./src/core/version.cpp
    - sed -i 's/HG_REVISION_NUMBER/'$(date +%s)'/g' ./src/core/version.cpp
    - sed -i 's/HG_TIME/"'$(date --iso-8601=seconds)'"/g' ./src/core/version.cpp
    # Skip irrelevant plugins
    - sed -i 's/add_opt_subdirectory(chocolate-doom)//g' ./src/plugins/CMakeLists.txt
    - sed -i 's/add_opt_subdirectory(odamex)//g' ./src/plugins/CMakeLists.txt
    - sed -i 's/add_opt_subdirectory(srb2)//g' ./src/plugins/CMakeLists.txt
    - sed -i 's/add_opt_subdirectory(turok2ex)//g' ./src/plugins/CMakeLists.txt

- name: bzdip2
  buildsystem: simple
  build-commands:
  - make -f Makefile-libbz2_so
  - install -D ./libbz2.so.1.0.8 /app/lib/libbz2.so.1.0.8
  - (cd /app/lib/ && ln -s libbz2.so.1.0.8 libbz2.so.1.0)
  sources:
  - type: archive
    url: https://www.sourceware.org/pub/bzip2/bzip2-latest.tar.gz
    sha256: ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269

- name: gdtoa
  disabled: true
  buildsystem: autotools
  build-commands:
  - install -D .libs/libgdtoa-1.0.so /app/lib/libgdtoa-1.0.so
  - (cd /app/lib/ && ln -s libgdtoa-1.0.so libgdtoa.so)
  sources:
  - type: git
    url: https://github.com/jwiegley/gdtoa.git
    branch: master
    
- name: fluidsynth
  buildsystem: cmake-ninja
  config-opts:
  - -DCMAKE_BUILD_TYPE=RelWithDebInfo
  - -DLIB_SUFFIX=
  # https://lists.nongnu.org/archive/html/fluid-dev/2010-10/msg00057.html
  - -DCMAKE_EXE_LINKER_FLAGS=-lncurses
  - -DCMAKE_SHARED_LINKER_FLAGS=-lncurses
  sources:
  - type: archive
    url: https://github.com/FluidSynth/fluidsynth/archive/v1.1.11.tar.gz
    sha256: da8878ff374d12392eecf87e96bad8711b8e76a154c25a571dd8614d1af80de8

- name: launcher
  buildsystem: simple
  sources:
  - type: file
    path: com.zandronum.Zandronum.desktop
  - type: file
    path: com.zandronum.Zandronum.appdata.xml
  - type: file
    path: com.zandronum.Zandronum.48.png
  - type: file
    path: com.zandronum.Zandronum.64.png
  - type: file
    path: com.zandronum.Zandronum.128.png
  - type: file
    url: https://github.com/coelckers/gzdoom/raw/g4.4.1/soundfont/gzdoom.sf2
    sha256: fca3e514b635a21789d4224e84865d2954a2a914d46b64aa8219ddb565c44869
  build-commands:
  - install -Dm 644 gzdoom.sf2 /app/share/sounds/sf2/gzdoom.sf2
  - install -Dm 644 com.zandronum.Zandronum.desktop -t /app/share/applications
  - install -Dm 644 com.zandronum.Zandronum.appdata.xml -t /app/share/metainfo
  - install -Dm 644 com.zandronum.Zandronum.48.png /app/share/icons/hicolor/48x48/apps/com.zandronum.Zandronum.png
  - install -Dm 644 com.zandronum.Zandronum.64.png /app/share/icons/hicolor/64x64/apps/com.zandronum.Zandronum.png
  - install -Dm 644 com.zandronum.Zandronum.128.png /app/share/icons/hicolor/128x128/apps/com.zandronum.Zandronum.png

