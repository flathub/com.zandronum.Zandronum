app-id: com.zandronum.Zandronum
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: 5.15-22.08
command: doomseeker.sh

finish-args:
  - --device=dri
  - --socket=x11
  - --share=ipc
  - --share=network
  - --socket=pulseaudio

  # Based on GZDoom
  # Now for something confusing: Doomseeker honours XDG standards
  # But Zandronum doesn't. Both persist for consistency.
  - --env=DOOMWADDIR=/app/share/games/doom
  - --persist=.config/zandronum
  - --persist=.config/doomseeker

cleanup:
  - /include
  - /lib/*.a
  - /lib/*.la
  - /lib/pkgconfig

modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - shared-modules/gtk2/gtk2.json

  - name: sdl12-compat
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/libsdl-org/sdl12-compat/archive/refs/tags/release-1.2.64.tar.gz
        sha256: 3e308e817c7f0c6383225485e9a67bf1119ad684b8cc519038671cc1b5d29861
        x-checker-data:
          type: anitya
          project-id: 242769
          url-template: https://github.com/libsdl-org/sdl12-compat/archive/refs/tags/release-$version.tar.gz

  - name: openssl11
    buildsystem: simple
    build-commands:
      - ./config --prefix=/app
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /share/doc
      - /share/man
    sources:
      - type: archive
        url: https://www.openssl.org/source/openssl-1.1.1t.tar.gz
        sha256: 8dee9b24bdb1dcbf0c3d1e9b02fb8f6bf22165e807f45adeb7c9677536859d3b
        x-checker-data:
          type: anitya
          project-id: 20333
          url-template: https://www.openssl.org/source/openssl-$version.tar.gz

  - name: fluidsynth1
    buildsystem: cmake-ninja
    disabled: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DLIB_SUFFIX=
      - -DCMAKE_EXE_LINKER_FLAGS=-lncurse
      - -DCMAKE_SHARED_LINKER_FLAGS=-lncurses
    sources:
      - type: archive
        url: https://github.com/FluidSynth/fluidsynth/archive/refs/tags/v1.1.11.tar.gz
        sha256: da8878ff374d12392eecf87e96bad8711b8e76a154c25a571dd8614d1af80de8

  - name: gme
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://bitbucket.org/mpyne/game-music-emu/downloads/game-music-emu-0.6.3.tar.gz
        sha256: 626e8a104e0dadd10ef6519a67aca880c7b40f81471659f1935b61754e12fc7b
        x-checker-data:
          type: anitya
          project-id: 866
          url-template: https://bitbucket.org/mpyne/game-music-emu/downloads/game-music-emu-$version.tar.gz

  - name: bzip2
    buildsystem: simple
    build-commands:
      - make -f Makefile-libbz2_so
      - install -D libbz2.so.1.0.8 /app/lib/libbz2.so.1.0.8
      - ln -s /app/lib/libbz2.so.1.0.8 /app/lib/libbz2.so.1.0
    sources:
      - type: archive
        url: https://github.com/opencor/bzip2/archive/refs/tags/bzip2-1.0.8.tar.gz
        sha256: db106b740252669664fd8f3a1c69fe7f689d5cd4b132f82ba82b9afba27627df
        x-checker-data:
          type: anitya
          project-id: 237
          url-template: https://github.com/opencor/bzip2/archive/refs/tags/bzip2-$version.tar.gz

  - name: doomseeker
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_SKIP_RPATH=true
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_PREFIX=/app
    sources:
      - type: archive
        url: https://bitbucket.org/Doomseeker/doomseeker/get/1.3.3.tar.bz2
        sha256: 12b406ee6e0d1f8a6710b56c79d9b6b84c96404dad2bbcb4824dab2aab440517
      - type: shell
        commands:
          # Package requires HG_ details for version numbers
          # Used to be based on Mercurial so that explains the naming
          - sed -i 's/HG_REVISION_HASH_STRING/"Flatpak Edition"/g' ./src/core/version.cpp
          - sed -i 's/HG_REVISION_NUMBER/'$(date +%s)'/g' ./src/core/version.cpp
          - sed -i 's/HG_TIME/"'$(date --iso-8601=seconds)'"/g' ./src/core/version.cpp
          # Skip irrelevant plugins
          - sed -i 's/add_opt_subdirectory(chocolate-doom)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(zandronumq)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(odamex)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(srb2)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(turok2ex)//g' ./src/plugins/CMakeLists.txt

  # Zandronum is such a work of art, that it's better for all of us to just
  # take the upstream package and call it a day.
  - name: zandronum
    buildsystem: simple
    build-commands:
      - tar -xf zandronum3.1-linux-x86_64.tar.bz2
      - install -D zandronum /app/bin/zandronum
      - install -D zandronum-server /app/bin/zandronum-server
      - install -D brightmaps.pk3 /app/share/games/brightmaps.pk3
      - install -D skulltag_actors.pk3 /app/share/games/skulltag_actors.pk3
      - install -D zandronum.pk3 /app/share/games/doom/zandronum.pk3
      - install -D libfmodex64-4.44.64.so /app/lib/libfmodex64-4.44.64.so
    sources:
      - type: file
        url: https://zandronum.com/downloads/zandronum3.1-linux-x86_64.tar.bz2
        sha256: 3dee92d2ab9ad9d7c485b46cac28c381e46ff9fe060695a9ca5034dd425dc9c6
        x-checker-data:
          type: html
          url: https://zandronum.com/download
          version-pattern: <p>The latest version is <strong>([\d\.]+)</strong>, released
            on December 2021.</p>
          url-template: https://zandronum.com/downloads/zandronum$version-linux-x86_64.tar.bz2

  - name: launcher
    buildsystem: simple
    build-commands:
      - install -Dm 744 doomseeker.sh /app/bin/doomseeker.sh
      - install -Dm 644 gzdoom.sf2 /app/share/sounds/sf2/gzdoom.sf2
      - install -Dm 644 com.zandronum.Zandronum.desktop -t /app/share/applications
      - install -Dm 644 com.zandronum.Zandronum.appdata.xml -t /app/share/metainfo
      - install -Dm 644 com.zandronum.Zandronum.48.png /app/share/icons/hicolor/48x48/apps/com.zandronum.Zandronum.png
      - install -Dm 644 com.zandronum.Zandronum.64.png /app/share/icons/hicolor/64x64/apps/com.zandronum.Zandronum.png
      - install -Dm 644 com.zandronum.Zandronum.128.png /app/share/icons/hicolor/128x128/apps/com.zandronum.Zandronum.png
    sources:
      - type: file
        path: com.zandronum.Zandronum.desktop
      - type: file
        path: com.zandronum.Zandronum.appdata.xml
      - type: file
        path: com.zandronum.Zandronum.48.png
      - type: file
        path: com.zandronum.Zandronum.64.png
      - type: file
        path: com.zandronum.Zandronum.128.png
      - type: file
        url: https://github.com/coelckers/gzdoom/raw/g4.8.2/soundfont/gzdoom.sf2
        sha256: fca3e514b635a21789d4224e84865d2954a2a914d46b64aa8219ddb565c44869
      - type: script
        dest-filename: doomseeker.sh
        commands:
          # Insert clean zandronum config if none defined
          - ls ~/.config/zandronum/zandronum.ini || /app/bin/zandronum -nosound -norun
          # Neccessery evil to ensure that Zandronum doesn't crash because of the outdated
          # FMOD library: https://zandronum.com/forum/viewtopic.php?t=9885
          - sed -i 's|\(snd_output=\)\(.*\)|\1SDL|g' ~/.config/zandronum/zandronum.ini
          - sed -i 's|\(snd_mididevice=\)\(.*\)|\1-3|g' ~/.config/zandronum/zandronum.ini
          - /app/bin/doomseeker

