app-id: com.zandronum.Zandronum
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: 5.15-25.08
command: doomseeker.sh

finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=pulseaudio

  # Based on GZDoom
  # Now for something confusing: Doomseeker honours XDG standards
  # But Zandronum doesn't. Both persist for consistency.
  - --env=DOOMWADDIR=/app/share/games/doom
  - --persist=.config/zandronum
  - --persist=.config/doomseeker

cleanup:
  - /include
  - /lib/*.a
  - /lib/*.la
  - /lib/pkgconfig

modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - shared-modules/gtk2/gtk2.json
  - shared-modules/gzdoom/game-music-emu.json
  - shared-modules/SDL/sdl12-compat.json

  - name: libjpeg
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_SKIP_RPATH:BOOL=YES
      - -DENABLE_STATIC:BOOL=NO
      - -DWITH_JPEG8:BOOL=YES
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
    sources:
      - type: archive
        url: https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/3.1.3.tar.gz
        sha256: 3a13a5ba767dc8264bc40b185e41368a80d5d5f945944d1dbaa4b2fb0099f4e5
        x-checker-data:
          type: anitya
          project-id: 1648
          url-template: https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/$version.tar.gz

  - name: openssl11
    buildsystem: simple
    build-commands:
      - ./config --prefix=/app
      - make -j $FLATPAK_BUILDER_N_JOBS
      - make install
    cleanup:
      - /share/doc
      - /share/man
    sources:
      - type: archive
        url: https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        sha256: cf3098950cb4d853ad95c0841f1f9c6d3dc102dccfcacd521d93925208b76ac8
        x-checker-data:
          type: anitya
          project-id: 20333
          url-template: https://www.openssl.org/source/openssl-$version.tar.gz

  - name: fluidsynth1
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - -DLIB_SUFFIX=
      - -DCMAKE_EXE_LINKER_FLAGS=-lncurses
      - -DCMAKE_SHARED_LINKER_FLAGS=-lncurses
      - -Denable-jack=OFF
    sources:
      - type: archive
        url: https://github.com/FluidSynth/fluidsynth/archive/refs/tags/v1.1.11.tar.gz
        sha256: da8878ff374d12392eecf87e96bad8711b8e76a154c25a571dd8614d1af80de8

  - name: bzip2
    buildsystem: simple
    build-commands:
      - make -f Makefile-libbz2_so
      - install -D libbz2.so.1.0.8 /app/lib/libbz2.so.1.0.8
      - ln -s /app/lib/libbz2.so.1.0.8 /app/lib/libbz2.so.1.0
    sources:
      - type: archive
        url: https://github.com/opencor/bzip2/archive/refs/tags/bzip2-1.0.8.tar.gz
        sha256: db106b740252669664fd8f3a1c69fe7f689d5cd4b132f82ba82b9afba27627df
        x-checker-data:
          type: anitya
          project-id: 237
          url-template: https://github.com/opencor/bzip2/archive/refs/tags/bzip2-$version.tar.gz

  - name: doomseeker
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_SKIP_RPATH=true
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_INSTALL_PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/DoomseekerTeam/Doomseeker/archive/refs/tags/1.5.3.tar.gz
        sha256: b22c170087b242e82ded086797e1746ce28e28dbec0d9ea207a6713b187b060e
      - type: shell
        commands:
          # Package requires HG_ details for version numbers
          # Used to be based on Mercurial so that explains the naming
          - sed -i 's/HG_REVISION_HASH_STRING/"Flatpak Edition"/g' ./src/core/version.cpp
          - sed -i 's/HG_REVISION_NUMBER/'$(date +%s)'/g' ./src/core/version.cpp
          - sed -i 's/HG_TIME/"'$(date --iso-8601=seconds)'"/g' ./src/core/version.cpp
          # Skip irrelevant plugins
          - sed -i 's/add_opt_subdirectory(chocolate-doom)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(zandronumq)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(odamex)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(srb2)//g' ./src/plugins/CMakeLists.txt
          - sed -i 's/add_opt_subdirectory(turok2ex)//g' ./src/plugins/CMakeLists.txt

  # Zandronum is such a work of art, that it's better for all of us to just
  # take the upstream package and call it a day.
  - name: zandronum
    buildsystem: simple
    build-commands:
      - tar -xf zandronum3.2.1-linux-x86_64.tar.bz2
      - install -D zandronum /app/bin/zandronum
      - install -D zandronum-server /app/bin/zandronum-server
      - install -D skulltag_actors.pk3 /app/share/games/skulltag_actors.pk3
      - install -D zandronum.pk3 /app/share/games/doom/zandronum.pk3
      - install -D libfmodex64-4.44.64.so /app/lib/libfmodex64-4.44.64.so
      - install -D liboutput_sdl.so /app/lib/liboutput_sdl.so
    sources:
      - type: file
        url: https://zandronum.com/downloads/zandronum3.2.1-linux-x86_64.tar.bz2
        sha256: 9f4b93ed99ab15d2406e697e2a06d956eb808c9ac2e53e62ae9f1affb53c86c0
        x-checker-data:
          type: html
          url: https://zandronum.com/download
          version-pattern: The latest version is <strong>([\d\.]+)</strong>
          url-template: https://zandronum.com/downloads/zandronum$version-linux-x86_64.tar.bz2

  # Unfunctional for the time being. Worth trying again later
  - name: soundfonts
    disabled: true
    buildsystem: simple
    build-commands:
      - install -Dm 644 gzdoom.sf2 /app/share/sounds/sf2/gzdoom.sf2
      - install -Dm 644 FluidR3_GM.sf2 /app/share/sounds/sf2/FluidR3_GM.sf2
      - install -Dm 644 FluidR3_GS.sf2 /app/share/sounds/sf2/FluidR3_GS.sf2
    sources:
      - type: file
        url: https://sources.debian.org/src/fluid-soundfont/3.1-5.2/FluidR3_GM.sf2/
        sha256: 74594e8f4250680adf590507a306655a299935343583256f3b722c48a1bc1cb0
      - type: file
        url: https://sources.debian.org/src/fluid-soundfont/3.1-5.2/FluidR3_GS.sf2/
        sha256: aadb5597fb95ea5f7d336999e3c68ad32aa6357027aed7d4d9ff0ac75f2988e6
      - type: file
        url: https://github.com/coelckers/gzdoom/raw/g4.8.2/soundfont/gzdoom.sf2
        sha256: fca3e514b635a21789d4224e84865d2954a2a914d46b64aa8219ddb565c44869

  - name: launcher
    buildsystem: simple
    build-commands:
      - install -Dm 744 doomseeker.sh /app/bin/doomseeker.sh
      - install -Dm 644 com.zandronum.Zandronum.desktop -t /app/share/applications
      - install -Dm 644 com.zandronum.Zandronum.appdata.xml -t /app/share/metainfo
      - install -Dm 644 com.zandronum.Zandronum.48.png /app/share/icons/hicolor/48x48/apps/com.zandronum.Zandronum.png
      - install -Dm 644 com.zandronum.Zandronum.64.png /app/share/icons/hicolor/64x64/apps/com.zandronum.Zandronum.png
      - install -Dm 644 com.zandronum.Zandronum.128.png /app/share/icons/hicolor/128x128/apps/com.zandronum.Zandronum.png
    sources:
      - type: file
        path: com.zandronum.Zandronum.desktop
      - type: file
        path: com.zandronum.Zandronum.appdata.xml
      - type: file
        path: com.zandronum.Zandronum.48.png
      - type: file
        path: com.zandronum.Zandronum.64.png
      - type: file
        path: com.zandronum.Zandronum.128.png
      - type: script
        dest-filename: doomseeker.sh
        commands:
          # Insert clean zandronum config if none defined
          - ls ~/.config/zandronum/zandronum.ini || /app/bin/zandronum -nosound -norun
          # Neccessery evil to ensure that Zandronum doesn't crash because of the outdated
          # FMOD library: https://zandronum.com/forum/viewtopic.php?t=9885
          # or because of weird paths with soundfonts
          - sed -i 's|\(snd_output=\)\(.*\)|\1SDL|g' ~/.config/zandronum/zandronum.ini
          - sed -i 's|\(snd_mididevice=\)\(.*\)|\1-3|g' ~/.config/zandronum/zandronum.ini
          - exec /app/bin/doomseeker


